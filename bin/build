#!/usr/bin/env bash
set -e

CURRENT_DIR=$(pwd)

if [[ ! $INPUT_DIR ]] || [[ ! $OUTPUT_DIR ]]; then
  echo "Input/Output directory variables must be set.\n"
  exit 1
fi

mkdir -p $INPUT_DIR
mkdir -p $OUTPUT_DIR

if [[ ! -d $INPUT_DIR ]] || [[ ! -d $OUTPUT_DIR ]]; then
  echo "Input/Output directories must exist.\n"
  exit 1
fi

# recursively search input directory for a package.json
PACKAGE_PATH=$(find $INPUT_DIR -name package.json ! -path "*/node_modules/*"  ! -path ".git/*"  | \
  awk -F'/' '{print $0 "," NF-1}' | \
  sort -t, -nk2 | awk -F',' '{print $1}' | \
  head -n 1)

if [[ $PACKAGE_PATH ]]; then
  printf "Package found: $PACKAGE_PATH\n"
  export PACKAGE_PATH
  npm-install
fi

cd $CURRENT_DIR
cp -R $INPUT_DIR/* $OUTPUT_DIR
